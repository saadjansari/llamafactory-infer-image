FROM 763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-inference:2.6.0-gpu-py312-cu124-ubuntu22.04-sagemaker

USER root

RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    libsndfile1 \
    ca-certificates \
    curl \
    jq \
    git \
  && rm -rf /var/lib/apt/lists/*

# Install runtime deps (avoid torch)
RUN python -m pip install --no-cache-dir -U pip \
 && python -m pip install --no-cache-dir \
    fastapi "uvicorn[standard]" \
    boto3 awscli \
    transformers accelerate safetensors einops \
    librosa audioread soundfile

# Optional: only add if your pipeline requires them
# RUN python -m pip install --no-cache-dir av decord opencv-python-headless

ENV HF_HOME=/tmp/hf_cache \
    TRANSFORMERS_CACHE=/tmp/hf_cache \
    HF_HUB_DISABLE_TELEMETRY=1 \
    TOKENIZERS_PARALLELISM=false

WORKDIR /opt/program
COPY serve.py /opt/program/serve.py
COPY start.sh /opt/program/start.sh
RUN chmod +x /opt/program/start.sh

EXPOSE 8080
ENTRYPOINT ["/opt/program/start.sh"]

